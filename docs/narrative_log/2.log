
<span class="stcmt">// Create adjusted outcome model &amp; chart</span>

<span class="stcmt">// Model: outcomes conditional on baseline student traits //</span>

<span class="stcmt">//note mi_motheredlevel omitted because missingness is already encoded as level 4 of motheredlevel so it's excluded from the full model</span>
	
	mlogit outcome c.age c.age#i.pathway c.hsgpa i.mi_hsgpa c.hsgpa#i.pathway i.male i.male#i.pathway c.pell i.mi_pell c.pell#i.pathway i.motheredlevel i.motheredlevel#i.pathway i.race i.race#i.pathway i.pathway i.institutionid i.cohortyear if cohorttermindex == 1, robust

<span class="stcmt">//note that because each student will have multiple rows in the data but with covariate values fixed at values observed at entry, we only need to run the regression with the first entry for each student</span>
	
<span class="stcmt">// Chart: pathway adjusted margins //</span>

	{
	margins pathway, predict(outcome(1)) predict(outcome(2))
	matrix ans = (r(b))'	
	cap frame drop working
	frame create working
	frame change working
	svmat2 ans, rnames(estimate_name)
	order estimate_name ans1
	rename ans1 prediction_
	gen outcome_level = ustrregexs(1) if ustrregexm(estimate_name, "^([0-9])")
	destring outcome_level, replace
	gen pathway_level = ustrregexs(1) if ustrregexm(estimate_name, "t.([0-9]+)")
	destring pathway_level, replace
	label define pathway_vals 1 "Some Pathway" 2 "Another Pathway" 3 "One More Pathway"//please modify appropriately; unfortunately, value labels do not copy automatically into new frames
	label values pathway_level pathway_vals
	drop estimate_name
	order outcome_level pathway_level	
	reshape wide prediction_, i(pathway_level) j(outcome_level) 	
		graph bar (asis) prediction_1 prediction_2, title("Adjusted Probability of Completion First" "or Transferring First by 	Pathway") ytitle("Adjusted Probability") b1("Pathway") over(pathway_level) stack ylabel(0(0.2)1) graphregion(fcolor(white))legend(label(1 "Completion First") label(2 "Transfer First")) xsize(5.5) note ("Note: A regression model adjusts probabilities to account for student demographic traits, institution, and cohort. Adjusted" "probabilities for each outcome are stacked.", size(vsmall)) bar(1, fcolor("51 34 136") lcolor(black)) bar(2, fcolor("68 170 153") lcolor(black)) 
		graph export "${saved_graphs}/2_main_adjusted.png", replace
	frame change default
	frame drop working	
	}
	
