
<span class="stcmt">/*****************************************</span>
<span class="stcmt"> Comments about this code</span>
<span class="stcmt">*****************************************</span>
<span class="stcmt"></span>
<span class="stcmt">// Data for this analysis code should be set up according to the </span>
<span class="stcmt">   accompanying data specification guide.</span>
<span class="stcmt"></span>
<span class="stcmt">// Code below for this analyis should be modified according to your needs. </span>
<span class="stcmt">   In some places, comments explicitly prompt you to appropriately modify a </span>
<span class="stcmt">   minimum number of commands for your institution's data, or else the </span>
<span class="stcmt">   output may not be correct or useful. And of course feel free to</span>
<span class="stcmt">   modify any other commands, too.</span>
<span class="stcmt"></span>
<span class="stcmt">// Stata version 16 or higher is required to run the code below, </span>
<span class="stcmt">   especially the frames-related commands. Earlier versions of </span>
<span class="stcmt">   Stata can be used if these commands are removed and replaced with </span>
<span class="stcmt">   similar functionality like tempfiles.</span>
<span class="stcmt"></span>
<span class="stcmt">// The code below varies considerably in complexity depending on which </span>
<span class="stcmt">   graph is being created. Stata's marginsplot command does</span>
<span class="stcmt">   not make it easy to create stacked bar graphs, which require </span>
<span class="stcmt">   more explicit, longer commands.</span>
<span class="stcmt"></span>
<span class="stcmt">// If you do not already have the user-written Stata command svmat2 </span>
<span class="stcmt">   installed, please see Stata's website for more guidance on </span>
<span class="stcmt">   how to install this. The appropriate installation approach might</span>
<span class="stcmt">   depend on the environment in which you are using Stata.</span>
<span class="stcmt"></span>
<span class="stcmt">// If you do not alraedy have the user-written Stata command grc1leg2 </span>
<span class="stcmt">   installed, please type "search grc1leg2" in the Stata  console for more </span>
<span class="stcmt">   installation information.</span>
<span class="stcmt"></span>
<span class="stcmt">// Note that this code does not create margins plots for all pairwise </span>
<span class="stcmt">   combinations of covariates in the model. Specifically, no </span>
<span class="stcmt">   plots are created for combinations of two continuous variables. Nor </span>
<span class="stcmt">   are redundant combinations included (e.g. a margins plot </span>
<span class="stcmt">   for race/ethnicity and gender is included once in the race/ethnicity </span>
<span class="stcmt">   graphing section, which appears before the gender graphing section).</span>
<span class="stcmt">	</span>
<span class="stcmt"></span>
<span class="stcmt"></span>
<span class="stcmt">***************************************</span>
<span class="stcmt"> Set up and setting filepaths</span>
<span class="stcmt">***************************************/</span>

version 16.1
clear all
macro drop all		

<span class="stcmt">// set path to your saved .csv data file matching spec document</span>
global path_to_data	<span class="stcmt">///</span>
"some_directory/perhaps_another_directory/maybe_even_one_more_directory/your_data.csv" 

<span class="stcmt">// set path for where you'd like graphs saved on your computer</span>
global saved_graphs <span class="stcmt">///</span>
"some_directory/perhaps_another_directory/finally_the_directory_where_you_would_like_your_graphs_saved" 



<span class="stcmt">/***************************************</span>
<span class="stcmt"> Load data set up according to spec</span>
<span class="stcmt">***************************************/</span>

import delimited "${path_to_data}"


<span class="stcmt">/********************************************</span>
<span class="stcmt"> Label variables as relevant to institution</span>
<span class="stcmt">********************************************/</span>

<span class="stcmt">// set these value labels according to your preferred conventions</span>
<span class="stcmt">* male</span>
label define male_vals 0 "Female" 1 "Male" 
label values male male_vals

<span class="stcmt">* race</span>
label define race_vals 1 "Asian" 2 "Black" 3 "Hispanic" 4 "White" 5 "Other"	
label values race race_vals

<span class="stcmt">* motheredlevel</span>
label define edlevel_vals 1 "Middle Sch" 2 "High Sch" 3 "Any College" 4 "NA"	
label values motheredlevel edlevel_vals

<span class="stcmt">* pathway</span>
label define pathway_entry_vals 1 "Some Pathway" 2 "Another Pathway" 3 "One More Pathway" 
label values pathway pathway_entry_vals
<span class="stcmt">/*this is just a placeholder example; please modify with the full names </span>
<span class="stcmt">associated with each entry pathway code at your institution */</span>

<span class="stcmt">/******************************************</span>
<span class="stcmt"> Generate additional variables</span>
<span class="stcmt">******************************************/</span>

<span class="stcmt">* Determine number of terms included in data for each student</span>
sum cohorttermindex
global max_term = r(max)		

<span class="stcmt">* Outcome variable at the student level, across terms</span>
gen outcome = 0
replace outcome = 1 if pathway == 100 &amp; cohorttermindex == $max_term
replace outcome = 2 if pathway == 101 &amp; cohorttermindex == $max_term
bys studentid (cohorttermindex): replace outcome = outcome[$max_term]

<span class="stcmt">* Label outcome</span>
label define outcome_vals 0 "None" 1 "Completion" 2 "Transfer"
label values outcome outcome_vals
label var outcome "student outcome after ${max_term} terms"

<span class="stcmt">* Code in an indicator for a terminating event (first completion or first transfer)</span>
gen terminating = inlist(pathway, 100, 101)	
label var terminating "indicator for a terminating event: first completion or transfer"

<span class="stcmt">* Generate an indicator for non-enrollment</span>
gen nonenrolled = pathway == 99
label var nonenrolled "indicator for non-enrollment in a term"	

<span class="stcmt">* Generate an entry pathway code for each student</span>
bys studentid (cohorttermindex): gen entry_pathway = pathway[1]
label var entry_pathway "pathway code associated with a student at entry"	

<span class="stcmt">* Label entry pathways</span>
label values entry_pathway pathway_entry_vals



<span class="stcmt">/**********************************</span>
<span class="stcmt"> Run regressions and plot margins</span>
<span class="stcmt">**********************************/</span>		

<span class="stcmt">* Model: outcomes conditional only on initial pathway choice</span>
mlogit outcome i.pathway if cohorttermindex == 1, robust 
<span class="stcmt">/* note that because each student will have multiple rows in the data </span>
<span class="stcmt">but with covariate values fixed at values observed at entry,</span>
<span class="stcmt">   we only need to run the regression with the first entry for each student*/</span>
	
<span class="stcmt">* Chart: pathway unadjusted margins</span>
{
margins pathway, predict(outcome(1)) predict(outcome(2))
matrix ans = (r(b))'
cap frame drop working
frame create working
frame change working
svmat2 ans, rnames(estimate_name)
order estimate_name ans1
rename ans1 prediction_
gen outcome_level = ustrregexs(1) if ustrregexm(estimate_name, "^([0-9])")
destring outcome_level, replace
gen pathway_level = ustrregexs(1) if ustrregexm(estimate_name, "t.([0-9]+)")
destring pathway_level, replace
drop estimate_name
order outcome_level pathway_level	
reshape wide prediction_, i(pathway_level) j(outcome_level) 	
<span class="stcmt">// please modify appropriately; unfortunately, value labels do not copy automatically into new frames</span>
label define pathway_vals 1 "Some Pathway" 2 "Another Pathway" 3 "One More Pathway" 
label values pathway_level pathway_vals
graph bar (asis) prediction_1 prediction_2, <span class="stcmt">///</span>
title("Probability of Completion First or Transferring First" "by Pathway") <span class="stcmt">///</span>
ytitle("Probability") b1("Pathway") over(pathway_level) <span class="stcmt">///</span>
stack ylabel(0(0.2)1) graphregion(fcolor(white)) <span class="stcmt">///</span>
legend(label(1 "Completion First") label(2 "Transfer First")) <span class="stcmt">///</span>
xsize(5.5) note("Note: Probabilities for each outcome are stacked.", <span class="stcmt">///</span>
size(vsmall)) bar(1, fcolor("51 34 136") <span class="stcmt">///</span>
lcolor(black)) bar(2, fcolor("68 170 153") lcolor(black)) 
<span class="stcmt">// colors chosen for colorblindness accessibility</span>
graph export "${saved_graphs}/1_main.png", replace
frame change default
frame drop working		
}

